<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-header class="ion-no-border">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/"></ion-back-button>
      </ion-buttons>
      <ion-buttons slot="end">
        <button class="top-right-button" (click)="imageDropdown(image)">
          <ion-icon name="ellipsis-vertical-outline"></ion-icon>
        </button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <div class="ion-padding" *ngIf="!errorMessage">
    <ion-card>
      <ion-item lines="none">
        <ion-avatar slot="start" (click)="openProfile(image?.postedBy)">
          <img [src]="generateAvatarUrl(image?.displayName || 'devvscape_user')" [attr.alt]="'COMPONENTS.SHARED.IMAGE_DETAILS.PROFILE_PICTURE' | transloco">
        </ion-avatar>
        <ion-label>
          <h2>{{ image?.displayName || "devvscape_user" }}</h2>
          <p>{{ image?.createdAt | dateAgo }}</p>
        </ion-label>
      </ion-item>

      <div class="shimmer" *ngIf="!imageLoaded"></div>

      <img
        [src]="image?.imageUrl"
        [alt]="image?.postText"
        (load)="imageLoaded = true"
        class="post-image"
      />

      <ion-card-header>
        <ion-card-subtitle
          *ngIf="image?.postText"
          [innerHTML]="formatCardSubtitle(image)"
        ></ion-card-subtitle>
        <a
          *ngIf="image?.postText.length > 200"
          class="read-more"
          (click)="toggleText()"
        >{{ isTextTruncated ? ('COMPONENTS.SHARED.IMAGE_DETAILS.READ_MORE' | transloco) : ('COMPONENTS.SHARED.IMAGE_DETAILS.SHOW_LESS' | transloco) }}</a>
      </ion-card-header>
    </ion-card>

    <!-- Comments Section -->
    <div class="comments-section">
      <ion-list lines="none">
        <ion-item *ngFor="let comment of image?.comments" class="comment-item">
          <ion-label>
            <div class="comment-content">
              <h4>{{ comment?.displayName || "devvscape_user" }} ~ <span class="comment-time">{{ comment?.createdAt | dateAgo }}</span></h4>
              <p>{{ comment.text }}</p>
            </div>
            <div class="comment-actions">
              <ion-button fill="clear" size="small" class="comment-action-button">
                <ion-icon name="heart-outline" slot="start"></ion-icon>
                {{ 'COMPONENTS.SHARED.IMAGE_DETAILS.LIKE' | transloco }}
              </ion-button>
              <ion-button fill="clear" size="small" class="comment-action-button">
                <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
                {{ 'COMPONENTS.SHARED.IMAGE_DETAILS.REPLY' | transloco }}
              </ion-button>
            </div>
          </ion-label>
        </ion-item>
      </ion-list>

      <!-- Comment Input -->
      <ion-item class="comment-input">
        <ion-avatar slot="start">
          <img [src]="generateAvatarUrl(currentUser?.displayName)" [attr.alt]="'COMPONENTS.SHARED.IMAGE_DETAILS.YOUR_AVATAR' | transloco">
        </ion-avatar>
        <ion-input
          [(ngModel)]="commentText"
          [placeholder]="'COMPONENTS.SHARED.IMAGE_DETAILS.ADD_COMMENT' | transloco"
          [maxlength]="maxLength"
          (ionChange)="onCommentChange()"
        ></ion-input>
        <ion-button
          *ngIf="image"
          slot="end"
          fill="clear"
          [disabled]="!commentText.trim()"
          (click)="imagePostComment(image)"
        >
          {{ 'COMPONENTS.SHARED.IMAGE_DETAILS.POST' | transloco }}
        </ion-button>
      </ion-item>
      <div class="input-counter" *ngIf="commentText">
        {{ commentText.length }}/{{ maxLength }}
      </div>
    </div>
  </div>

  <ion-item *ngIf="errorMessage" class="error-message">
    <ion-label color="danger">
      {{ errorMessage }}
    </ion-label>
  </ion-item>
</ion-content>
